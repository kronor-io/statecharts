-----------------------------------------------------------------------------------------------
--
--                                        :::::::::::
--                                        : WARNING :
--                                        :::::::::::
--
--                                   DO NOT EDIT THIS FILE
--                               IT WAS AUTOMATICALLY GENERATED
--                                CHANGES MAY BE OVERWRITTEN
--
-----------------------------------------------------------------------------------------------
BEGIN;
      -----------------------------------------------
      -- helper setup 
      -----------------------------------------------
      create temporary table intercepted (
        event text not null,
        event_date timestamptz not null default now()
      );
      create or replace function last_intercepted()
        returns text as
        $$
          begin
            select event from intercepted order by event_date desc limit 1;
          end
        $$ language plpgsql strict;
      -- TODO could this still be useful?
      --create or replace function fsm.handle_machine_events(shard bigint, machine_id bigint)
      --  returns void as
      --$$
      --  begin
      --    return;
      --  end;
      --$$ language plpgsql volatile strict;
      -----------------------------------------------
      -- INTERCEPTION ò.ó
      -----------------------------------------------
      alter function invoice.created_action(event_payload fsm_event_payload) 
      rename to created_action_original;
      create function invoice.created_action(event_payload fsm_event_payload)
        returns void as
      $$
        begin
          insert into intercepted (event) values ('invoice.created_action');
          --select invoice.created_action_original(event_payload::fsm_event_payload);
          return;
        end;
      $$ language plpgsql volatile strict;
      ------------------------------------------------------------------
      alter function invoice.soft_reminder_action(event_payload fsm_event_payload) 
      rename to soft_reminder_action_original;
      create function invoice.soft_reminder_action(event_payload fsm_event_payload)
        returns void as
      $$
        begin
          insert into intercepted (event) values ('invoice.soft_reminder_action');
          --select invoice.soft_reminder_action_original(event_payload::fsm_event_payload);
          return;
        end;
      $$ language plpgsql volatile strict;
      -----------------------------------------------
      -- SETUP
      -----------------------------------------------
      select id as machine_id from fsm.start_machine_with_latest_statechart(1, 'invoice_flow') \gset
      -----------------------------------------------
      -- REAL TESTING
      -----------------------------------------------
      select plan(1);
        ------------------------------------------------
        select count(*) from fsm.state_machine_state where state_id = 'settling';
        select count(*) from fsm.state_machine_state where state_id = 'in_progress';
        select count(*) from fsm.state_machine_state where state_id = 'created';
        select count(*) from intercepted where event = 'invoice.created_action';
        ------------------------------------------------
        select fsm.notify_state_machine(1::bigint, :machine_id::bigint, 'invoice.time.soft_reminder');
        select count(*) from fsm.state_machine_state where state_id = 'settling';
        select count(*) from fsm.state_machine_state where state_id = 'in_progress';
        select count(*) from fsm.state_machine_state where state_id = 'in_progress_soft_reminder';
        select count(*) from intercepted where event = 'invoice.created_action';
        ------------------------------------------------
        --select notify_state_machine(1,:mid, '', ''::jsonb);
        --with bar as bar (select fsm.state_machine_state where ...;
        --with foo as foo (select last_intercepted()) select is(:foo,'invoice.due_date_action');
        ------------------------------------------------
      select finish();

ROLLBACK;
