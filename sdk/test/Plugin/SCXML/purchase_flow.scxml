<scxml xmlns="http://www.w3.org/2005/07/scxml"
              version="1.0"
              initial="assessing">
  <state id="assessing" name="risk assessing">
    <transition event="order.cancelled.manually" target="cancelled"/>
    <transition event="assessment.approved" target="waiting_for_capture"/>
    <initial>
      <transition target="pre_flight_scoring"/>
    </initial>
    <state id="pre_flight_scoring" name="pre flight assessment">
      <transition event="preflight.approved" target="sca_required"/>
    </state>
    <state id="sca_required" name="authenticating customer">
      <transition event="auth.approved" target="risk_scoring"/>
    </state>
    <final id="risk_scoring" name="risk scoring customer">
      <onentry>
        <script src="dna.enqueue_job_fetch_uc_report" />
      </onentry>
    </final>
  </state>
  <state id="waiting_for_capture" name="waiting for capture">
    <transition event="activated" target="payment_or_return"/>
    <initial>
      <transition target="waiting"/>
    </initial>
    <state id="waiting" name="waiting for capture">
      <onentry>
        <script src="checkout.promote_purchase_order" />
      </onentry>
      <transition event="purchase.capture.partially" target="captured_partially"/>
      <transition event="purchase.capture.fully" target="captured_fully"/>
      <transition event="purchase.cancelled.manually" target="cancelled_fully"/>
    </state>
    <state id="cancelled_partially" name="partially cancelled">
    </state>
    <state id="captured_partially" name="captured partially">
      <transition event="purchase.capture.fully" target="captured_fully"/>
      <transition event="purchase.cancelled.manually" target="cancelled_partially"/>
    </state>
    <final id="cancelled_fully" name="fully cancelled">
    </final>
    <final id="captured_fully" name="captured fully">
    </final>
  </state>
  <state id="payment_or_return" name="Waiting for full payment or full return">
    <initial>
      <transition target="waiting_for_payment"/>
    </initial>
    <state id="waiting_for_payment" name="Waiting for payment">
      <transition event="fully_returned" target="fully_returned"/>
      <transition event="invoice.paid" target="paid"/>
    </state>
    <state id="paid" name="Paid">
      <transition event="fully_returned" target="fully_returned"/>
      <transition event="return_policy_over" target="done"/>
      <transition event="returned.partial" target="returned_after_paid"/>
    </state>
    <state id="returned_after_paid" name="Paid with returned items">
      <transition event="fully_returned" target="fully_returned"/>
      <transition event="return_policy_over" target="done"/>
      <transition event="returned.fully" target="fully_returned"/>
      <transition event="return_policy.timeout" target="done"/>
    </state>
    <final id="fully_returned" name="Fully returned">
    </final>
    <final id="done" name="All done">
    </final>
  </state>
  <final id="cancelled" name="Order cancelled">
  </final>
</scxml>
