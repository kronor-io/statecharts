<scxml xmlns="http://www.w3.org/2005/07/scxml"
              version="1.0"
              initial="waiting_for_capture">
  <state id="waiting_for_capture" name="waiting for capture">
    <transition event="payment.initialize" target="initializing"/>
    <onentry>
      <script src="runtime.check_for_capture" />
    </onentry>
  </state>
  <state id="initializing" name="initialize payment">
    <transition event="payment.created" target="waiting_for_payment"/>
    <transition event="payment.cancel" target="cancelled"/>
    <transition event="payment.error" target="error"/>
    <onentry>
      <script src="runtime.enqueue_payment_create_job" />
    </onentry>
  </state>
  <state id="waiting_for_payment" name="waiting for payment">
    <transition event="payment.paid" target="paid"/>
    <transition event="payment.declined" target="declined"/>
    <transition event="payment.cancelled" target="cancelled"/>
    <transition event="payment.error" target="error"/>
    <onentry>
      <script src="runtime.enqueue_payment_polling_job" />
    </onentry>
    <initial>
      <transition target="processing"/>
    </initial>
    <state id="processing" name="processing the payment">
    <transition event="payment.cancel" target="cancelling"/>
    </state>
    <state id="cancelling" name="cancel payment request">
      <onentry>
        <script src="runtime.enqueue_payment_cancel_job" />
      </onentry>
      <transition event="payment.cancel.failed" target="processing"/>
    </state>
  </state>

  <final id="paid" name="paid">
    <onentry>
      <script src="runtime.promote_payment_to_marketplace" />
    </onentry>
  </final>

  <final id="error" name="error">
  </final>

  <final id="declined" name="payment declined">
  </final>

  <final id="cancelled" name="payment cancelled">
  </final>

</scxml>
